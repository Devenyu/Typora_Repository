# DeviceNet协议

## 一、DeviceNet的特性

![](https://img.devenyu.top/img/image-20211124092857223.png)

## 二、CAN芯片与DeviceNet

在前面章节中讲述的执行CAN协议的CAN芯片可由多家制造商提供。产品设计人员必须仔细地选择CAN芯片。你必须完全理解你的产品将怎样使用DeviceNet，以及你的应用所必须的处理过程。进而，你需要理解DeviceNet在CAN基础上是如何运行的，CAN的功能是什么，以及CAN芯片是怎样工作的。

### 2.1、接收过滤器的数量

接收过滤器可以被想象成一个滤网，或标识符滤网。任何通过接收过滤器的信息必须由服务器于CAN控制器的处理器进行处理。筛去的无关数据项越多，对处理器的影响就越少。

在CAN芯片内过滤器有两种类型：

- 固定式：要求位精确匹配的过滤器，一一对应。。
- 屏蔽和匹配：在与接受代码寄存器比较之前，对标识符域运用掩码的过滤器。允许某些位成为无关位。

例如，在图中掩码寄存器被配置成接收到的标识位的第10-6位必须与接收代码寄存器中的第10-6位符合。在这个例子中接收标识位的第 10-6 位必须 为 11110，剩余部分可为任意值。如果位 10-6 是 11110，那么这一信息将被接收，而不管位 5-0 中的值是什么。

![](https://img.devenyu.top/img/image-20211124094039407.png)

**重点提示 DeviceNet 的基础是 CAN 标准帧（11 位标识区）的定义。**

### 2.2、CAN中断速率

图中表示一个CAN接收器在最坏情况下的中断速率。

![](https://img.devenyu.top/img/image-20211124094330815.png)

![](https://img.devenyu.top/img/image-20211124094346228.png)

## 三、DeviceNet的连接及报文协议

### 3.1、概述

DeviceNet 是一个基于连接的通信网络系统。一个 DeviceNet 的连接提供了多个应用之间的路径。当 建立连接时，与连接相关的传送会被分配一个连接 ID（CID）。如果连接包含双向交换那么应当分配两个连 接 ID 值。连接与连接 ID 如图所示。

![](https://img.devenyu.top/img/image-20211124140733767.png)

### 3.2、CAN标识符使用

DeviceNet 建立在标准 CAN2.0A 协议之上，并使用 11 位标准报文标识符，可分成 4 个单独的报文组，如表所示。同样，基于扩展 CAN2.0B 协议的 CAN 节点也可以兼容设计成一个 DeviceNet 设备。

![报文组的定义](https://img.devenyu.top/img/image-20211124140827748.png)

在 DeviceNet 中，CAN 标识符被称为连接 ID。它包含报文组 ID、该组中的报文 ID、设备 MAC ID。 源和目标地址都可作为 MAC ID。定义取决于报文组和报文 ID。系统中报文的含义由报文 ID 确定。

4 个报文组分别有以下用途： 

- 报文组 1  **分配了 1024 个 CAN 标识符（000H~3FFH）**，占所有可用标识符的一半。该组中每个设备最多可拥有 16 个不同的报文。该组报文的优先级主要由报文 ID（报文的含义）决定。如果 2 个设备同时发送报文，报 文 ID 号较小的设备总是先发送。以这种方式可以相对容易地建立一个 16 个优先级的系统。报文组 1 通常 用于 I/O 报文交换应用数据。 
- 报文组 2  **分配了 512 个标识符（400H~5FFH）**。该组的大多数报文 ID 可选择定义为“预定义主/从连接集”。其 中 1 个报文 ID 定义为网络管理。优先级主要由设备地址（MAC ID）决定，其次由报文 ID 决定。如果要 考虑各位的具体位置，那么带 8 位屏蔽的 CAN 控制器可以根据 MAC ID 滤除自身的报文组 2 报文。
- 报文组 3  **分配了 448 个标识符（600H~7BFH）**，具有与报文组 1 相似的结构。与报文组 1 不同的是，它主要交 换低优先级的过程数据。此外，该组的主要用途是建立动态的显式连接。每个设备可有 7 个不同的报文， 其中 2 个报文保留作未连接报文管理器端口（UCMMPort）。
- 报文组 4  **分配了 48 个 CAN 标识符（7C0H~7EFH）**，不包含任何设备地址，只有报文 ID。该组的报文只用于网 络管理。通常分配 4 个报文 ID 用于“离线连接集”。
- 其它 16 个 CAN 标识符（7F0H~7FFH）在 DeviceNet 中被禁止。







## 四、DeviceNet信息协议

### 4.1、显式信息

显式信息利用CAN帧的数据区来传递DeviceNet定义的信息。

![显式信息CAN数据区的使用](https://img.devenyu.top/img/image-20211124095212959.png)

![显式信息数据区格式](https://img.devenyu.top/img/image-20211124095241563.png)

含有完整显式信息的传送数据区包括：

- 信息头
- 完整的信息体

如果显式信息的长度大于8字节，则必须在DeviceNet上以分段方式传输。连接对象提供分段/重组功能。一个显式信息的分段包括：

- 信息头
- 分段协议
- 分段信息体

#### 4.1.1、信息头

显式信息的CAN数据区的0号字节指定信息头，格式如下：

![显式信息头格式](https://img.devenyu.top/img/image-20211124095645262.png)

**信息头内容：**

**Frag**（分段位）——指示此传输是否为显式信息的一个分段。值定义如下：

![分段位的值定义](https://img.devenyu.top/img/image-20211124095756278.png)

**XID**（事务处理ID）——该区应用程序用以匹配响应和相关请求。该区由服务器用响应信息简单回复。服务器模块并不利用该区执行任何类型的重复信息检测逻辑。当一个客户机发出一个不需要响应的显式信息时，该区所含值可忽略。

**MAC ID**——包含源MAC ID或目标MAC ID。根据表来确定该区域中指定何种MAC ID（源或目标）

![信息头内的MAC ID](https://img.devenyu.top/img/image-20211124101236860.png)

>接收显式信息是，须检查信息头内的MAC ID区，如果在连接ID中指定目标MAC ID，那么必须在信息头中指定其他端点的源MAC ID。如果在连接ID中指定源MAC ID，那么必须在信息头中指定接收模块的MAC ID。如果两种情况的检查都失败，则放弃该消息。

检查信息头内MAC ID的另一个作用是能够使用相同的连接ID来表示用不同的显式信息连接到不同的设备通信。这只有在显式信息连接ID中包含源设备的MAC ID时才能实现，这是由于目的MAC ID将在信息头中指定，并且也可在接收过程中使用。例如：

假设一个设备（MAC ID值为0A hex）通过信息组3跟另一个设备（MAC ID值为02hex）建立了一个显式信息连接。

![](https://img.devenyu.top/img/image-20211124131751461.png)

由于在CAN数据区中指定了目的MAC ID，所以虽然设备X在第一个连接中仍正在使用，但它可以在其他设备的另一个显式信息连接中使用信息ID5.

![](https://img.devenyu.top/img/image-20211124132051933.png)

这样增加了设备可以建立的显式信息连接的数量。这一方法的缺点：当向另一个不同设备发送显式信息时，该设备将经历一次不必要的网络中断。如上图，每当设备X向设备Y发送一个信息，设备Z都将经历一次网络中断。

#### 4.1.2、信息体

信息体包含服务区和服务特定变量。

信息体指定的第一个变量时服务区，用于识别正在传送的特定请求或响应。

![服务区格式](https://img.devenyu.top/img/image-20211124133300728.png)

服务区内容：

- 服务代码——服务区字节低7位指定的值，表示传送服务的类型。
- R/R——服务区的最高位。该值决定了这个信息是请求信息还是响应信息

![R/R位规范](https://img.devenyu.top/img/image-20211124140226203.png)

当服务区产生一个响应，表明已成功地执行了请求时，服务区将包含请求服务代码，其请求/响应标志置为1。

#### 4.1.3、分段协议

如果传输的是显式信息的一个分段，那么该数据区包含信息头、分段协议以及信息体分段。分段协议用于大段显式信息的分段转发及重组。

#### 4.1.4、UCMM服务

非连接信息管理器（UCMM）提供动态建立显式信息连接。本节详细介绍与UCMM提供的打开显式信息连接及关闭连接服务有关的特定服务变量。

UCMM处理两种服务即管理显式信息连接的分配及解除：

- 打开显式信息连接-服务代码 = 4B (hex) 。用于建立一个显式信息连接。
- 关闭连接-服务代码 = 4C（hex）。用于删除一个连接对象并解除所有相关资源。

#### 4.1.5、打开显式信息连接请求

该服务要求在两个模块之间建立一个逻辑连接，以便通过该连接发送显式信息。该服务可作为非连接请求信息发送。

![打开显式信息连接请求格式](https://img.devenyu.top/img/image-20211124144221593.png)

参量：

**Frag[0]/事务处理 ID/MAC ID**——信息头。注意：在与打开显式信息连接请求/响应相关的信息头中指定目的MAC ID。

**R/R位（0）**——表明这是一个请求信息。

**服务代码（4BH）**——表明这是打开显式信息连接服务。

**保留位**——留待开发使用。这些位当前可被接收器忽略，并由该发送器置零。

**请求的信息体格式**——客户机利用该区，为随后在该连接上传输的显式信息请求特定的信息体格式。

**重要信息**：响应打开显式信息请求的服务器模块定义在该连接上使用的实际信息体格式。

信息体的格式见表：

![信息体格式值](https://img.devenyu.top/img/image-20211124161337435.png)

服务器能够执行下列任务：

- 拒绝请求并在打开显式信息连接响应中返回对应的格式。
- 在打开显式信息连接响应中返回一个相同的值，以接受该请求。

**组选择**——该区指示信息组，通过该信息组交换与此连接相关的信息。定义下列值：

![组选择值](https://img.devenyu.top/img/image-20211124161949465.png)

**重要信息**：客户机选择信息组，通过该信息组传送与此显式信息连接相关的信息。如果服务器不能满足请求，那么它必须拒绝这个请求并返回一个出错响应。

**源信息ID**——这个区域的使用将取决于组选择区内的值。如下表：

![打开显式信息连接请求内的源信息ID](https://img.devenyu.top/img/image-20211124162154099.png)

#### 4.1.6、打开显式信息连接成功响应

该服务用于打开显式信息连接请求信息成功地响应。

![打开显式信息连接响应格式](https://img.devenyu.top/img/image-20211124162438257.png)

**参量**：

**Frag（0）/事务处理ID/MAC ID**——信息头。注意：目的MAC ID始终在打开显式信息连接的请求/响应相关的信息头中指定。

**R/R位（1）**——表示这是一个响应信息。

**服务代码（4BH）**——表示这是一个打开显式信息连接服务。

**保留位**——留待开发使用。这些位可被当前接收器忽略，并由发送器置零。

**实际信息体格式**——该区由服务器用来定义在这一连接上随后发送的显式信息有关的信息体的格式。在发送一个打开显式信息连接请求时，客户机在请求的信息体格式参量中请求一个特定的格式。

**目的信息ID**——该区的使用将依据于信息组，客户机通过信息组请求该连接发生。

![打开显式信息连接响应中的目的信息ID](https://img.devenyu.top/img/image-20211124164958442.png)

**源信息ID**——服务器已分配的信息ID值。服务器从它的组1,2或3信息ID库中分配一个信息ID，与它自己的MAC ID（源 MAC ID）结合，当服务器通过这个连接发生一个信息时，以产生它指定的连接ID。这给了客户机足够的信息来配置与它相关的链路消费者和CAN芯片，用以接收由服务器实施的传输。

**连接实例ID** ——当服务器成功地完成一个开放请求服务时，它展示了一个显式信息连接对象。这个区保留分配给显式信息连接对象的实例ID值。当服务器希望关闭此连接时，它将该连接实例ID值返回给客户机，供其随后使用。这个连接实例ID区在打开显式信息连接响应内指定一个16位整数场中。

#### 4.1.7、打开显式信息连接协议实例

![](https://img.devenyu.top/img/image-20211124170410555.png)

>注意：服务器通过实际信息体格式区中返回某个值来接受请求的信息体格式。与此连接相关的客户机和服务器随后的发送将使用下列连接ID：

![](https://img.devenyu.top/img/image-20211124171500925.png)

------

![](https://img.devenyu.top/img/image-20211124172746252.png)

>注意：服务器拒绝请求的信息体格式并替之的实际格式是DeviceNet（8/16）。与此连接相关的客户机和服务器随后的发送将使用下列连接ID：

![](https://img.devenyu.top/img/image-20211124173007908.png)

------

![](https://img.devenyu.top/img/image-20211124173109608.png)

>注意：服务器通过在实际信息体格式区中返回某个值来接受请求的信息体格式。与此连接相关的客户机和服务器随后的发送将使用下列连接ID：

![](https://img.devenyu.top/img/image-20211124173253641.png)

------

下面的例子图示说明跟在出错响应后的打开显式信息连接请求。

![](https://img.devenyu.top/img/image-20211124174236997.png)

#### 4.1.8、关闭连接请求

该服务用于终止在某个端点上的连接（I/O或信息）。由UCMM接受的关闭信息导致调用连接分裂删除服务。关闭连接请求作为非连接的请求信息发送。

**重要信息：**打开显式信息连接请求/响应服务只用来建立显式信息连接；但是，关闭服务可用于终止任一类型。

关闭连接请求提供了一种方法，不用建立一个显式信息连接就能删除一连接。在一个显式信息连接上向连接类传送DeviceNet公共删除服务也能实现与关闭服务相同的功能。但是，删除服务只能作为基于连接的信息发送。

![关闭连接请求格式](httpss://img.devenyu.top/img/image-20211127134455918.png)

**参量**：

**Frag（0）/事务处理ID/MAC ID**——信息头。注意：目的MAC ID始终在打开显式信息连接的请求/响应相关的信息头中指定。

**R/R位（0）**——表示这是一个请求信息。

**服务代码（4CH）**——表示这是一个关闭连接服务。

**连接实例ID **——清除指定连接实例的区。由于关闭连接请求信息作为一个非连接信息被发送，发送器可能并不知道与预定接收器相关的信息体格式的情况。因此，在这个信息内的连接实例ID的格式永远被指定为一个16位整数。

**服务过程：**响应方检查指定的连接实例是否存在。如果连接实例存在，并且能够被删除，即将其删除。所有与此连接实例相关的资源都被释放。如果请求成功地执行，则返回一个关闭响应。如果请求没有成功地执行，则返回一个出错响应。

#### 4.1.9、关闭响应

此服务用于成功地响应一个关闭请求信息。

![关闭连接响应格式](https://img.devenyu.top/img/image-20211127142322183.png)

**参量：**

**Frag（0）/事务处理ID/MAC ID**。

**R/R位（1）**——表明这是一个响应信息。注意：目的MAC ID总是在与一个关闭连接请求/响应相关的信息头中被指定。

**服务代码（4CH）**——表明这是一个关闭连接服务。

#### 4.1.10、关闭连接协议实例

下列例子描述了一个关闭连接请求/响应事务处理。

![](https://img.devenyu.top/img/image-20211127143701301.png)

#### 4.1.11、出错响应

出错响应信息的格式。本节提供了与错误条件及错误代码信息有关的UCMM标准组，该信息在相关错误响应信息中使用。

![](https://img.devenyu.top/img/image-20211127144228828.png)

错误条件说明：

- **服务不打开或关闭**——不支持UCMM端口收到的服务。
- **组选择资源错误**——组选择参量表明使用了设备不支持的信息组。
- **组选择超出范围**——组选择区包含一个无效值。
- **服务器连接溢出**——该服务器已经达到了最大支持连接数。
- **服务器信息ID溢出**——服务器已将客户机请求的信息组内的所有信息ID分配完毕。
- **客户机源信息ID无效**——打开显式信息连接请求所接受的源信息ID对指定的信息组无效。
- **客户机源信息ID重复**——在一个打开显式信息连接请求中收到的源信息ID和源MAC ID已经用于组1或组3显式信息连接。在这种情况下，作为已存在的显式信息连接，请求在同一MAC ID指定的同一组选择（1或3）及源信息ID已被接受。



## DeviceNet服务代码和服务名称

## DeviceNet服务代码和服务名称

![](https://img.devenyu.top/img/image-20211123202136705.png)

```c
public enum DnExplicitServices : byte
    {
        Get_Attributes_All = 0x01,
        Set_Attributes_All = 0x02,
        Get_Attribute_List = 0x03,
        Set_Attribute_List = 0x04,
        Reset = 0x05,
        Start = 0x06,
        Stop = 0x07,
        Create = 0x08,
        Delete = 0x09,
        Multiple_Service_Packet = 0x0A,
        Apply_Attributes = 0x0D,
        Get_Attribute_Single = 0x0E,
        Set_Attribute_Single = 0x10,
        Find_Next_Object_Instance = 0x11,
        Error_Response = 0x14,
        Restore = 0x15,
        Save = 0x16,
        No_Operation = 0x17,
        Get_Member = 0x18,
        Set_Member = 0x19,
        Insert_Member = 0x1A,
        Remove_Member = 0x1B,
        GroupSync = 0x1C,
        Response = 0x80
    }
```

1、Get_Attribute_All

服务代码： 01 hex 

返回一个对象或类的所有属性内容。 

服务要求 

有关 Get_Attribute_All 服务的详细要求如下：

1. 成功响应的服务数据区中的信息结构和类或对象定义的 Get_Attribute_All 响应结 构一致 若支持此类服务, 要求对象和/或类提供有关响应信息中数据发送格式的详 细定义 
2. 如果请求服务成功 则返回 Get_Attribute_All 响应 响应的服务数据区包含属性 数据 如果检测到错误 则返回出错响应

2、Set_Attributes_All(设置全部属性)

服务代码 02 hex 

修改对象或类的属性的内容。 

服务要求 

有关 Set_Attribute_All 服务的详细要求如下：

 1. 请求的服务数据区中的信息结构与类或对象 Set_Attributes_All 请求的定义一致。支持此类服务要求对象和/或类提供有关请求信息中数据发送格式的详细定义 。
 2. 如果修改属性的能力随对象的状态而改变 对象定义必须提供有关服务是如何受影响的详细说明。例如：此服务只在所有属性处于可修改状态时才得到支持。或者，对象可以忽略与目前不可修改属性有关的数据 。
 3. 只有在全部属性值都检查（例如范围核查等等）成功时才会修改属性。第一个属性检查失败将在出错响应信息的附加代码参数中表现出来。
 4. 如果检测到一个错误，则返回出错响应。
 5. 如果所有检查都通过，则属性被修改且返回一个 Set_Attributes_All 成功响应。



## 预定义主/从连接组

![预定义主/从连接组标识区](https://img.devenyu.top/img/image-20211124205019190.png)

